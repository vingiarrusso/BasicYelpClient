var Q = require('q'),
    querystring = require('querystring'),
    OAuth = require('oauth').OAuth,
    config = require('config').Yelp,
    BASE_URL = 'http://api.yelp.com/v2/';

function YelpClient() {
  this.oauth = new OAuth(
    null,
    null,
    config.consumerKey,
    config.consumerSecret,
    "1.0",
    null,
    'HMAC-SHA1'
  );
}

YelpClient.prototype.get = function(api, params) {
  var url = BASE_URL + api + (params ? '?' + querystring.stringify(params) : ""),
      deferred = Q.defer();

  this.oauth.get(
    url,
    config.token,
    config.tokenSecret,
    function(err, data, res) {
      if (!err && data) {
        deferred.resolve(JSON.parse(data));
      } else {
        deferred.reject(err);
      }
    }
  );

  return deferred.promise;
};

YelpClient.prototype.search = function(params) {
  return this.get('search', params);
};

module.exports.createYelpClient = function() {
  return new YelpClient();
};
